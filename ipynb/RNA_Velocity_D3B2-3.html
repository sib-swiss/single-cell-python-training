<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial transcriptomics - RNA velocity with scvelo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/SIB_logo.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro">


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Spatial transcriptomics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../precourse_preparations.html"> 
<span class="menu-text">Pre-course preparations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../course_schedule.html"> 
<span class="menu-text">Course schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../quality_control.ipynb"> 
<span class="menu-text">Quality control</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-course-material" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Course material</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-course-material">    
        <li>
    <a class="dropdown-item" href="../ipynb/Quality_Control_D1B2_Controls.html">
 <span class="dropdown-text">Quality control</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../ipynb/Normalization_And_Scaling_D1B3_Controls.html">
 <span class="dropdown-text">Normalization and scaling</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/sib-swiss/single-cell-python-training/"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">RNA velocity with scvelo</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/SIB_LogoQ_GBv.svg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#dynamical-modeling-of-rna-velocity" id="toc-dynamical-modeling-of-rna-velocity" class="nav-link active" data-scroll-target="#dynamical-modeling-of-rna-velocity">Dynamical modeling of RNA velocity</a></li>
  <li><a href="#velocities-in-cycling-progenitors" id="toc-velocities-in-cycling-progenitors" class="nav-link" data-scroll-target="#velocities-in-cycling-progenitors">Velocities in cycling progenitors</a></li>
  <li><a href="#generic-ml" id="toc-generic-ml" class="nav-link" data-scroll-target="#generic-ml">generic &amp; ml</a></li>
  <li><a href="#scrna-seq" id="toc-scrna-seq" class="nav-link" data-scroll-target="#scrna-seq">scRNA-seq</a>
  <ul class="collapse">
  <li><a href="#load-and-filter-dataset" id="toc-load-and-filter-dataset" class="nav-link" data-scroll-target="#load-and-filter-dataset">Load and filter dataset</a></li>
  </ul></li>
  <li><a href="#initialize-cycle-and-phase-objects-with-priors" id="toc-initialize-cycle-and-phase-objects-with-priors" class="nav-link" data-scroll-target="#initialize-cycle-and-phase-objects-with-priors">Initialize cycle and phase objects with priors</a>
  <ul class="collapse">
  <li><a href="#run-the-manifold-learning-module" id="toc-run-the-manifold-learning-module" class="nav-link" data-scroll-target="#run-the-manifold-learning-module">Run the manifold-learning module</a></li>
  <li><a href="#visualize-the-results" id="toc-visualize-the-results" class="nav-link" data-scroll-target="#visualize-the-results">Visualize the results</a></li>
  <li><a href="#run-the-velocity-learning-module" id="toc-run-the-velocity-learning-module" class="nav-link" data-scroll-target="#run-the-velocity-learning-module">Run the velocity-learning module</a></li>
  </ul></li>
  <li><a href="#initialize-cycle-and-phase-objects-with-priors-1" id="toc-initialize-cycle-and-phase-objects-with-priors-1" class="nav-link" data-scroll-target="#initialize-cycle-and-phase-objects-with-priors-1">Initialize cycle and phase objects with priors</a></li>
  <li><a href="#run-the-manifold-learning-module-1" id="toc-run-the-manifold-learning-module-1" class="nav-link" data-scroll-target="#run-the-manifold-learning-module-1">Run the manifold-learning module</a>
  <ul class="collapse">
  <li><a href="#visualize-the-results-1" id="toc-visualize-the-results-1" class="nav-link" data-scroll-target="#visualize-the-results-1">Visualize the results</a></li>
  </ul></li>
  <li><a href="#run-the-velocity-learning-module-1" id="toc-run-the-velocity-learning-module-1" class="nav-link" data-scroll-target="#run-the-velocity-learning-module-1">Run the velocity-learning module</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">RNA velocity with scvelo</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="df6cd295-a490-41c2-9479-31aff3fa5211" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scvelo <span class="im">as</span> scv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>RNA velocity is a method for estimating the rate of change in gene expression in scRNA-seq dataset. Differently from pseudotime trajectory inference, where you need to specify a “root” cell, RNA velocity tells you the direction along which cells are evolving in gene expression space. RNA velocity achieves this by examining the ratio of unspliced (intronic-containing) and spliced (exonic-only) reads in a dataset.</p>
<p>In the previous notebook, we walked through the theoretical foundations behind RNA velocity. Here, we will demonstrate how to practically apply it to a dataset using the scvelo package, which is nicely integrated with the scanpy framework we have been working with during the past two days. This exercise is partially adapted from several tutorials on the scvelo documentation page: https://scvelo.readthedocs.io/</p>
<p>First, we will load a dataset on pancreatic endocrinogenesis</p>
<div id="1ca75a8a-9b5a-4d77-a6db-9cd83ea59f16" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> scv.datasets.pancreas()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>adata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>AnnData object with n_obs × n_vars = 3696 × 27998
    obs: 'clusters_coarse', 'clusters', 'S_score', 'G2M_score'
    var: 'highly_variable_genes'
    uns: 'clusters_coarse_colors', 'clusters_colors', 'day_colors', 'neighbors', 'pca'
    obsm: 'X_pca', 'X_umap'
    layers: 'spliced', 'unspliced'
    obsp: 'distances', 'connectivities'</code></pre>
</div>
</div>
<p><strong>Exercise 1</strong>: As we can see from the metadata, this dataset already contains a low dimensional UMAP embedding with cluster annotations. Can you plot this UMAP embedding, coloring the cells by <code>clusters</code>?</p>
<div id="860a84bf-7e5f-4404-84e2-813fac4796c0" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'clusters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Next, we display the proportions of spliced/unspliced counts. Depending on the protocol used , we typically have between 10%-25% of unspliced molecules containing intronic sequences. For single-nuclei data, you will have many more intronic reads, approximately 60%-70%. We also advice you to examine the variations on cluster level to verify consistency in splicing efficiency. Here, we find variations as expected, with slightly lower unspliced proportions at cycling ductal cells, then higher proportion at cell fate commitment in Ngn3-high and Pre-endocrine cells where many genes start to be transcribed.</p>
<div id="2e94721c-8c8c-45f2-8824-c05605c1a68f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>scv.pl.proportions(adata, groupby<span class="op">=</span><span class="st">"clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Next, as with our standard scRNA-seq analysis pipeline, we need to preprocess the data! This requires performing the following steps, which you have studied in previous exercises: - Gene filtering (with a minimum number of counts per cell) - Normalization - Log transformation</p>
<p>In scvelo, these steps are combined into a single function, called <code>scv.pp.filter_and_normalize</code>. We will run that command below with two parameters specified: - <code>min_shared_counts</code> requires a minimum number of counts (both spliced and unspliced) for all genes; any other genes are filtered out - <code>n_top_genes</code> is similar to <code>sc.pp.highly_variable_genes</code> from scanpy, finding the top variable genes and filtering out the others</p>
<div id="8c9ffb87-19e3-46b2-8512-0a56b9db67e2" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>scv.pp.filter_and_normalize(adata, min_shared_counts<span class="op">=</span><span class="dv">20</span>, n_top_genes<span class="op">=</span><span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered out 20801 genes that are detected 20 counts (shared).
Normalized count data: X, spliced, unspliced.
Extracted 2000 highly variable genes.
Logarithmized X.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/lederer/anaconda3/envs/velocycle/lib/python3.10/site-packages/scvelo/preprocessing/utils.py:705: DeprecationWarning: `log1p` is deprecated since scVelo v0.3.0 and will be removed in a future version. Please use `log1p` from `scanpy.pp` instead.
  log1p(adata)</code></pre>
</div>
</div>
<p><strong>Exercise 2</strong>: As we mentioned, <code>scv.pp.filter_and_normalize</code> combines several scanpy functions into a single command. However, if you want full control over the filtering, normalization, and log-transformation steps, you can run each command individually. Can you write the five lines of code needed to achieve the above steps?</p>
<p><strong>Answer</strong></p>
<p>Next, we need to compute a PCA and neighborhood graph, as we have done previously.</p>
<p><strong>Exercise 3</strong>: Write the commands to compute the PCA and then the neighborhood graph (using <code>n_pcs=30</code> and <code>n_neighbors=30</code>)</p>
<div id="495a26bf-d6b1-4f87-bba3-8fccaaae1e39" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sc.pp.pca(adata)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(adata, n_pcs<span class="op">=</span><span class="dv">30</span>, n_neighbors<span class="op">=</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we need to compute the first and second order moments (means and uncentered variances) computed among nearest neighbors in PCA space, summarized in <code>scv.pp.moments</code>.</p>
<div id="8f76e710-863b-4c5c-8a98-ccffafec297a" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>scv.pp.moments(adata, n_pcs<span class="op">=</span><span class="va">None</span>, n_neighbors<span class="op">=</span><span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing moments based on connectivities
    finished (0:00:00) --&gt; added 
    'Ms' and 'Mu', moments of un/spliced abundances (adata.layers)</code></pre>
</div>
</div>
<p>Velocities are vectors in gene expression space and represent the direction and speed of movement of the individual cells. The velocities are obtained by modeling transcriptional dynamics of splicing kinetics, either stochastically (default) or deterministically (by setting mode=‘deterministic’). For each gene, a steady-state-ratio of pre-mature (unspliced) and mature (spliced) mRNA counts is fitted, which constitutes a constant transcriptional state. Velocities are then obtained as residuals from this ratio. Positive velocity indicates that a gene is up-regulated, which occurs for cells that show higher abundance of unspliced mRNA for that gene than expected in steady state. Conversely, negative velocity indicates that a gene is down-regulated.</p>
<div id="6e191191-bea1-4638-9548-14f172dd8b3c" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>scv.tl.velocity(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing velocities
    finished (0:00:00) --&gt; added 
    'velocity', velocity vectors for each individual cell (adata.layers)</code></pre>
</div>
</div>
<p>The combination of velocities across genes can then be used to estimate the future state of an individual cell. In order to project the velocities into a lower-dimensional embedding, transition probabilities of cell-to-cell transitions are estimated. That is, for each velocity vector we find the likely cell transitions that are accordance with that direction. The transition probabilities are computed using cosine correlation between the potential cell-to-cell transitions and the velocity vector, and are stored in a matrix denoted as velocity graph. The resulting velocity graph has dimension 𝑛𝑜𝑏𝑠×𝑛𝑜𝑏𝑠 and summarizes the possible cell state changes that are well explained through the velocity vectors (for runtime speedup it can also be computed on reduced PCA space by setting approx=True).</p>
<div id="1e2e6fd8-58d4-403f-82ba-b910ba4fafc9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>scv.tl.velocity_graph(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing velocity graph (using 1/32 cores)
    finished (0:00:04) --&gt; added 
    'velocity_graph', sparse matrix with cosine correlations (adata.uns)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"78c272624b6347a386d664e97d9ab3c5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Finally, the velocities are projected onto any embedding, specified by basis, and visualized in one of these ways: - on cellular level with scv.pl.velocity_embedding, - as gridlines with scv.pl.velocity_embedding_grid, - or as streamlines with scv.pl.velocity_embedding_stream.</p>
<p>Note, that the data has an already pre-computed UMAP embedding, and annotated clusters. When applying to your own data, these can be obtained with scv.tl.umap and scv.tl.louvain.</p>
<p>The most fine-grained resolution of the velocity vector field we get at single-cell level, with each arrow showing the direction and speed of movement of an individual cell. That reveals, e.g., the early endocrine commitment of Ngn3-cells (yellow) and a clear-cut difference between near-terminal α-cells (blue) and transient β-cells (green).</p>
<div id="7bb82e71-e13c-4d41-968b-dc9efce21a52" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>scv.pl.velocity_embedding(adata, arrow_length<span class="op">=</span><span class="dv">3</span>, arrow_size<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'clusters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing velocity embedding
    finished (0:00:00) --&gt; added
    'velocity_umap', embedded velocity vectors (adata.obsm)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The velocity vector field displayed as streamlines yields fine-grained insights into the developmental processes. It accurately delineates the cycling population of ductal cells and endocrine progenitors. Further, it illuminates cell states of lineage commitment, cell-cycle exit, and endocrine cell differentiation.</p>
<div id="0b97db50-f02a-464f-9cf9-88417a8992fb" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>scv.pl.velocity_embedding_stream(adata, basis<span class="op">=</span><span class="st">'umap'</span>, color<span class="op">=</span><span class="st">'clusters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This is perhaps the most important part as we advise the user not to limit biological conclusions to the projected velocities, but to examine individual gene dynamics via phase portraits to understand how inferred directions are supported by particular genes.</p>
<p><strong>As we discussed in our previous exercise into the theoretical foundations of RNA velocity</strong>: Gene activity is orchestrated by transcriptional regulation. Transcriptional induction for a particular gene results in an increase of (newly transcribed) precursor unspliced mRNAs while, conversely, repression or absence of transcription results in a decrease of unspliced mRNAs. Spliced mRNAs is produced from unspliced mRNA and follows the same trend with a time lag. Time is a hidden/latent variable. Thus, the dynamics needs to be inferred from what is actually measured: spliced and unspliced mRNAs as displayed in the phase portrait.</p>
<p>Now, let us examine the phase portraits of some marker genes, visualized with scv.pl.velocity(adata, gene_names) or scv.pl.scatter(adata, gene_names).</p>
<div id="b902fe7c-e722-4fd7-9af2-de7cd9d98989" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>scv.pl.velocity(adata, [<span class="st">'Cpe'</span>,  <span class="st">'Gnao1'</span>, <span class="st">'Ins2'</span>, <span class="st">'Adk'</span>], ncols<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Exercise 4</strong>: Describe the plots above: what can you tell me about the patterns of the four genes, Cpe, Gnao1, Ins2, Adk, along the differentiation trajectory. Transitioning from ductal cells to mature alpha and beta cells, which genes are being upregulated? Which genes are being downregulated along the same trajectory? Are any of the genes limited to a particular cell type or lineage?</p>
<p><strong>Answer</strong>: Cpe explains the directionality in the up-regulated Ngn3 (yellow) to Pre-endocrine (orange) to β-cells (green), while Adk explains the directionality in the down-regulated Ductal (dark green) to Ngn3 (yellow) to the remaining endocrine cells.</p>
<div id="46b15895-0684-46c5-ab67-35ce8bf2babf" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, <span class="st">'Cpe'</span>, color<span class="op">=</span>[<span class="st">'clusters'</span>, <span class="st">'velocity'</span>],</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>               add_outline<span class="op">=</span><span class="st">'Ngn3 high EP, Pre-endocrine, Beta'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Exercise 5</strong>: What does the black dashed line represent in the phase portrait plots, and how does this relate to the way in which RNA velocity is determined?</p>
<p><strong>Answer</strong>: The black line corresponds to the estimated ‘steady-state’ ratio, i.e.&nbsp;the ratio of unspliced to spliced mRNA abundance which is in a constant transcriptional state. RNA velocity for a particular gene is determined as the residual, i.e.&nbsp;how much an observation deviates from that steady-state line.</p>
<p>We need a systematic way to identify genes that may help explain the resulting vector field and inferred lineages. To do so, we can test which genes have cluster-specific differential velocity expression, being siginificantly higher/lower compared to the remaining population. The module scv.tl.rank_velocity_genes runs a differential velocity t-test and outpus a gene ranking for each cluster. Thresholds can be set (e.g.&nbsp;min_corr) to restrict the test on a selection of gene candidates.</p>
<div id="0382d7a6-dfe8-46f0-a28e-08f6c863dac8" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>scv.tl.rank_velocity_genes(adata, groupby<span class="op">=</span><span class="st">'clusters'</span>, min_corr<span class="op">=</span><span class="fl">.3</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(adata.uns[<span class="st">'rank_velocity_genes'</span>][<span class="st">'names'</span>])</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ranking velocity genes
    finished (0:00:00) --&gt; added 
    'rank_velocity_genes', sorted scores by group ids (adata.uns) 
    'spearmans_score', spearmans correlation scores (adata.var)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/lederer/anaconda3/envs/velocycle/lib/python3.10/site-packages/scvelo/tools/utils.py:463: DeprecationWarning: Please use `rankdata` from the `scipy.stats` namespace, the `scipy.stats.stats` namespace is deprecated.
  from scipy.stats.stats import rankdata</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Ductal</th>
<th data-quarto-table-cell-role="th">Ngn3 low EP</th>
<th data-quarto-table-cell-role="th">Ngn3 high EP</th>
<th data-quarto-table-cell-role="th">Pre-endocrine</th>
<th data-quarto-table-cell-role="th">Beta</th>
<th data-quarto-table-cell-role="th">Alpha</th>
<th data-quarto-table-cell-role="th">Delta</th>
<th data-quarto-table-cell-role="th">Epsilon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Notch2</td>
<td>Ptpn3</td>
<td>Pde1c</td>
<td>Baiap3</td>
<td>Pax6</td>
<td>Zcchc16</td>
<td>Zdbf2</td>
<td>Heg1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Sox5</td>
<td>Hspa8</td>
<td>Pclo</td>
<td>Pam</td>
<td>Unc5c</td>
<td>Nell1</td>
<td>Ptprt</td>
<td>Ica1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Hspa8</td>
<td>Dcbld1</td>
<td>Ptprs</td>
<td>Sdk1</td>
<td>Nnat</td>
<td>Ksr2</td>
<td>Akr1c19</td>
<td>Tmcc3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Krt19</td>
<td>Grb10</td>
<td>Rap1gap2</td>
<td>Abcc8</td>
<td>Kcnmb2</td>
<td>Prune2</td>
<td>Ank2</td>
<td>Gpr179</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Nr2f6</td>
<td>Hacd1</td>
<td>Kcnb2</td>
<td>Ptprn2</td>
<td>Scg3</td>
<td>Ndst4</td>
<td>Spock3</td>
<td>Mamld1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="462655e7-d8dd-42ef-8939-d6f4e354d77c" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>kwargs <span class="op">=</span> <span class="bu">dict</span>(frameon<span class="op">=</span><span class="va">False</span>, size<span class="op">=</span><span class="dv">10</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>              add_outline<span class="op">=</span><span class="st">'Ngn3 high EP, Pre-endocrine, Beta'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, df[<span class="st">'Ngn3 high EP'</span>][:<span class="dv">5</span>], ylabel<span class="op">=</span><span class="st">'Ngn3 high EP'</span>, <span class="op">**</span>kwargs)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, df[<span class="st">'Pre-endocrine'</span>][:<span class="dv">5</span>], ylabel<span class="op">=</span><span class="st">'Pre-endocrine'</span>, <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The genes Ptprs, Pclo, Pam, Abcc8, Gnas, for instance, support the directionality from Ngn3 high EP (yellow) to Pre-endocrine (orange) to Beta (green).</p>
<section id="dynamical-modeling-of-rna-velocity" class="level2">
<h2 class="anchored" data-anchor-id="dynamical-modeling-of-rna-velocity">Dynamical modeling of RNA velocity</h2>
<p>Since RNA velocity yields insights into the directionality of gene expression change, we can use the approach to infer a trajectory. One way this is acheives is by recovering estimates of the full transcriptional dynamics (i.e., the transcription rate, the splicing rate, and the degradation rate) instead of using the steady-state asusmption and linear fits. This is particularly useful when you have a dataset without a cluster of cells representing the “steady-state”.</p>
<p>Dynamical modeling of RNA velocity is possible with scvelo and allows for: - Estimation of a latent time - Identification of possible driver genes</p>
<p>We run the dynamical model to learn the full transcriptional dynamics of splicing kinetics.</p>
<p>It is solved in a likelihood-based expectation-maximization framework, by iteratively estimating the parameters of reaction rates and latent cell-specific variables, i.e.&nbsp;transcriptional state and cell-internal latent time. It thereby aims to learn the unspliced/spliced phase trajectory for each gene.</p>
<div id="424340d0-f3a5-4821-a57b-dd9b566d8f65" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>scv.tl.recover_dynamics(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>recovering dynamics (using 1/32 cores)
    finished (0:03:30) --&gt; added 
    'fit_pars', fitted parameters for splicing dynamics (adata.var)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"eb6bb268b9a2414788f626c8bbbf2236","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Then, we before we need to estiamte the velocity and compute the velocity graph, specifying this time the “dynamical” mode.</p>
<div id="9e0781f1-c835-45e9-bf7a-0a5d488bc43d" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>scv.tl.velocity(adata, mode<span class="op">=</span><span class="st">'dynamical'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>scv.tl.velocity_graph(adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing velocities
    finished (0:00:02) --&gt; added 
    'velocity', velocity vectors for each individual cell (adata.layers)
computing velocity graph (using 1/32 cores)
    finished (0:00:02) --&gt; added 
    'velocity_graph', sparse matrix with cosine correlations (adata.uns)</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"98d23a0425d74862b1cd8dd0cfcb4049","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Running the dynamical model can take a while (up to 10 mins for this dataset)</p>
<div id="f725a448-881e-421e-98a7-b5b225f74b8c" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>scv.pl.velocity_embedding_stream(adata, basis<span class="op">=</span><span class="st">'umap'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing velocity embedding
    finished (0:00:00) --&gt; added
    'velocity_umap', embedded velocity vectors (adata.obsm)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-19-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The rates of RNA transcription, splicing and degradation are estimated without the need of any experimental data.</p>
<p>They can be useful to better understand the cell identity and phenotypic heterogeneity.</p>
<div id="cf811069-dff9-484a-8259-b30d771fc763" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> adata.var</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[(df[<span class="st">'fit_likelihood'</span>] <span class="op">&gt;</span> <span class="fl">.1</span>) <span class="op">&amp;</span> df[<span class="st">'velocity_genes'</span>] <span class="op">==</span> <span class="va">True</span>]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>kwargs <span class="op">=</span> <span class="bu">dict</span>(xscale<span class="op">=</span><span class="st">'log'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> scv.GridSpec(ncols<span class="op">=</span><span class="dv">3</span>) <span class="im">as</span> pl:</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    pl.hist(df[<span class="st">'fit_alpha'</span>], xlabel<span class="op">=</span><span class="st">'transcription rate'</span>, <span class="op">**</span>kwargs)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    pl.hist(df[<span class="st">'fit_beta'</span>] <span class="op">*</span> df[<span class="st">'fit_scaling'</span>], xlabel<span class="op">=</span><span class="st">'splicing rate'</span>, xticks<span class="op">=</span>[<span class="fl">.1</span>, <span class="fl">.4</span>, <span class="dv">1</span>], <span class="op">**</span>kwargs)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    pl.hist(df[<span class="st">'fit_gamma'</span>], xlabel<span class="op">=</span><span class="st">'degradation rate'</span>, xticks<span class="op">=</span>[<span class="fl">.1</span>, <span class="fl">.4</span>, <span class="dv">1</span>], <span class="op">**</span>kwargs)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>scv.get_df(adata, <span class="st">'fit*'</span>, dropna<span class="op">=</span><span class="va">True</span>).head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fit_alpha</th>
<th data-quarto-table-cell-role="th">fit_beta</th>
<th data-quarto-table-cell-role="th">fit_gamma</th>
<th data-quarto-table-cell-role="th">fit_t_</th>
<th data-quarto-table-cell-role="th">fit_scaling</th>
<th data-quarto-table-cell-role="th">fit_std_u</th>
<th data-quarto-table-cell-role="th">fit_std_s</th>
<th data-quarto-table-cell-role="th">fit_likelihood</th>
<th data-quarto-table-cell-role="th">fit_u0</th>
<th data-quarto-table-cell-role="th">fit_s0</th>
<th data-quarto-table-cell-role="th">fit_pval_steady</th>
<th data-quarto-table-cell-role="th">fit_steady_u</th>
<th data-quarto-table-cell-role="th">fit_steady_s</th>
<th data-quarto-table-cell-role="th">fit_variance</th>
<th data-quarto-table-cell-role="th">fit_alignment_scaling</th>
<th data-quarto-table-cell-role="th">fit_r2</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Sntg1</td>
<td>0.011041</td>
<td>0.004043</td>
<td>0.080231</td>
<td>25.527206</td>
<td>52.120241</td>
<td>1.021111</td>
<td>0.023619</td>
<td>0.367464</td>
<td>0.0</td>
<td>0.0</td>
<td>0.008509</td>
<td>2.507244</td>
<td>0.075472</td>
<td>0.259419</td>
<td>6.120456</td>
<td>0.466323</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sbspon</td>
<td>0.225797</td>
<td>1.682173</td>
<td>0.302747</td>
<td>6.147519</td>
<td>0.463775</td>
<td>0.057540</td>
<td>0.175868</td>
<td>0.242276</td>
<td>0.0</td>
<td>0.0</td>
<td>0.215998</td>
<td>0.162373</td>
<td>0.481733</td>
<td>0.794976</td>
<td>1.816960</td>
<td>0.651425</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mcm3</td>
<td>4.098365</td>
<td>59.257791</td>
<td>1.203317</td>
<td>1.986274</td>
<td>0.012154</td>
<td>0.015394</td>
<td>0.687152</td>
<td>0.125647</td>
<td>0.0</td>
<td>0.0</td>
<td>0.480542</td>
<td>0.060191</td>
<td>1.991981</td>
<td>0.985103</td>
<td>0.717393</td>
<td>0.282687</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Fam135a</td>
<td>0.169396</td>
<td>0.113233</td>
<td>0.185499</td>
<td>11.025427</td>
<td>1.057786</td>
<td>0.350119</td>
<td>0.153911</td>
<td>0.271898</td>
<td>0.0</td>
<td>0.0</td>
<td>0.414863</td>
<td>1.239550</td>
<td>0.397954</td>
<td>0.730658</td>
<td>3.569145</td>
<td>0.362124</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Adgrb3</td>
<td>0.039118</td>
<td>0.007863</td>
<td>0.195750</td>
<td>7.880056</td>
<td>118.323538</td>
<td>2.063335</td>
<td>0.028773</td>
<td>0.362395</td>
<td>0.0</td>
<td>0.0</td>
<td>0.072837</td>
<td>4.881226</td>
<td>0.095819</td>
<td>0.380088</td>
<td>1.773425</td>
<td>0.376199</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>The dynamical model recovers the latent time of the underlying cellular processes. This latent time represents the cell’s internal clock and approximates the real time experienced by cells as they differentiate, based only on its transcriptional dynamics. This offers advantages over traditional pseudotime trajectory inference approaches.</p>
<div id="7ccae805-3aa0-42d0-bab7-6e5b5eff2b7a" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>scv.tl.latent_time(adata)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, color<span class="op">=</span><span class="st">'latent_time'</span>, color_map<span class="op">=</span><span class="st">'gnuplot'</span>, size<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>computing terminal states
    identified 1 region of root cells and 1 region of end points .
    finished (0:00:00) --&gt; added
    'root_cells', root cells of Markov diffusion process (adata.obs)
    'end_points', end points of Markov diffusion process (adata.obs)
computing latent time using root_cells as prior
    finished (0:00:00) --&gt; added 
    'latent_time', shared time (adata.obs)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Driver genes display pronounced dynamic behavior and are systematically detected via their characterization by high likelihoods in the dynamic model. We can plot a heatmap of the top 300 genes expressed along the pseudotime.</p>
<div id="4c624ce9-ca74-4651-ab39-4a0cc95a6e5d" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>top_genes <span class="op">=</span> adata.var[<span class="st">'fit_likelihood'</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>).index[:<span class="dv">300</span>]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>scv.pl.heatmap(adata, var_names<span class="op">=</span>top_genes, sortby<span class="op">=</span><span class="st">'latent_time'</span>, col_color<span class="op">=</span><span class="st">'clusters'</span>, n_convolve<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For any top candidates that you might want to validate biologically, it is always essential to examine the phase portraits, to ensure that the gene is not too noisy.</p>
<div id="eb97d1e7-65b7-4e87-a192-a5aa9c7d75a6" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>top_genes <span class="op">=</span> adata.var[<span class="st">'fit_likelihood'</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>).index</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, basis<span class="op">=</span>top_genes[:<span class="dv">15</span>], ncols<span class="op">=</span><span class="dv">5</span>, frameon<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7dbfe5d3-c53b-4851-bfe6-141d96b5d6f9" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>var_names <span class="op">=</span> [<span class="st">'Actn4'</span>, <span class="st">'Ppp3ca'</span>, <span class="st">'Cpe'</span>, <span class="st">'Nnat'</span>]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, var_names, frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, x<span class="op">=</span><span class="st">'latent_time'</span>, y<span class="op">=</span>var_names, frameon<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-24-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="03d6cb99-e45a-4cc3-b063-83a04e0551d6" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>scv.tl.rank_dynamical_genes(adata, groupby<span class="op">=</span><span class="st">'clusters'</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> scv.get_df(adata, <span class="st">'rank_dynamical_genes/names'</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ranking genes by cluster-specific likelihoods
    finished (0:00:01) --&gt; added 
    'rank_dynamical_genes', sorted scores by group ids (adata.uns)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Ductal</th>
<th data-quarto-table-cell-role="th">Ngn3 low EP</th>
<th data-quarto-table-cell-role="th">Ngn3 high EP</th>
<th data-quarto-table-cell-role="th">Pre-endocrine</th>
<th data-quarto-table-cell-role="th">Beta</th>
<th data-quarto-table-cell-role="th">Alpha</th>
<th data-quarto-table-cell-role="th">Delta</th>
<th data-quarto-table-cell-role="th">Epsilon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Nfib</td>
<td>Top2a</td>
<td>Gnas</td>
<td>Abcc8</td>
<td>Pcsk2</td>
<td>Pak3</td>
<td>Pcsk2</td>
<td>Tox3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Dcdc2a</td>
<td>Dcdc2a</td>
<td>Rbfox3</td>
<td>Ppp3ca</td>
<td>Ank</td>
<td>Gnao1</td>
<td>Pak3</td>
<td>Meis2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Top2a</td>
<td>Adk</td>
<td>Btbd17</td>
<td>Rap1b</td>
<td>Scgn</td>
<td>Cpe</td>
<td>Rap1b</td>
<td>Rnf130</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Incenp</td>
<td>Rap1gap2</td>
<td>Tcp11</td>
<td>Gnas</td>
<td>Tspan7</td>
<td>Rph3al</td>
<td>Meis2</td>
<td>Adk</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Shank2</td>
<td>Tpx2</td>
<td>Mapre3</td>
<td>Tox3</td>
<td>Map1b</td>
<td>Rap1b</td>
<td>Map1b</td>
<td>Rap1b</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="138f3b3a-6872-4a0e-811d-b1ccd0b4e375" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster <span class="kw">in</span> [<span class="st">'Ductal'</span>, <span class="st">'Ngn3 high EP'</span>, <span class="st">'Pre-endocrine'</span>, <span class="st">'Beta'</span>]:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    scv.pl.scatter(adata, df[cluster][:<span class="dv">5</span>], ylabel<span class="op">=</span>cluster, frameon<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-26-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-26-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="velocities-in-cycling-progenitors" class="level2">
<h2 class="anchored" data-anchor-id="velocities-in-cycling-progenitors">Velocities in cycling progenitors</h2>
<p>The cell cycle detected by RNA velocity, and it is biologically affirmed by cell cycle scores (standardized scores of mean expression levels of phase marker genes).</p>
<div id="6b380d25-aea5-4f06-92be-cfbac69368be" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>scv.tl.score_genes_cell_cycle(adata)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, color_gradients<span class="op">=</span>[<span class="st">'S_score'</span>, <span class="st">'G2M_score'</span>], smooth<span class="op">=</span><span class="va">True</span>, perc<span class="op">=</span>[<span class="dv">5</span>, <span class="dv">95</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>calculating cell cycle phase
--&gt;     'S_score' and 'G2M_score', scores of cell cycle phases (adata.obs)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-28-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For the cycling Ductal cells, we may screen through S and G2M phase markers. The previous module also computed a spearmans correlation score, which we can use to rank/sort the phase marker genes to then display their phase portraits.</p>
<div id="9685e98c-bc51-4bad-a7c2-d07f5bb4955d" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>s_genes, g2m_genes <span class="op">=</span> scv.utils.get_phase_marker_genes(adata)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>s_genes <span class="op">=</span> scv.get_df(adata[:, s_genes], <span class="st">'spearmans_score'</span>, sort_values<span class="op">=</span><span class="va">True</span>).index</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>g2m_genes <span class="op">=</span> scv.get_df(adata[:, g2m_genes], <span class="st">'spearmans_score'</span>, sort_values<span class="op">=</span><span class="va">True</span>).index</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>kwargs <span class="op">=</span> <span class="bu">dict</span>(frameon<span class="op">=</span><span class="va">False</span>, ylabel<span class="op">=</span><span class="st">'cell cycle genes'</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>scv.pl.scatter(adata, <span class="bu">list</span>(s_genes[:<span class="dv">2</span>]) <span class="op">+</span> <span class="bu">list</span>(g2m_genes[:<span class="dv">3</span>]), <span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Particularly Hells and Top2a are well-suited to explain the vector field in the cycling progenitors. Top2a gets assigned a high velocity shortly before it actually peaks in the G2M phase. There, the negative velocity then perfectly matches the immediately following down-regulation.</p>
<div id="f2a5e738-b803-4918-9be7-aa245aac482d" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>scv.pl.velocity(adata, [<span class="st">'Hells'</span>, <span class="st">'Top2a'</span>], ncols<span class="op">=</span><span class="dv">2</span>, add_outline<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The cell cycle is an interesting case for RNA velocity estimation, as pseudotime methods along often fail as estimations of cyclical processes. Moreover, RNA velocity corresponds roughly to cell cycle speed, which is both experimentally verifiable. The cell cycle also unfolds on a timescale of less than 24 hours, which is well suited for studying cell dynamics using RNA lifecycle kinetics, such as with RNA velocity.</p>
<p>A recent method has been developed called <strong>VeloCycle</strong> to estimate RNA velocity of the cell cycle on the real time scale. This method offers several advantages over existing approaches: - The ability to estimate uncertainty of velocity estimates (i.e.&nbsp;velocity confidence). - The ability to estimate both the low dimensional manifold and the velocity jointly. - The ability to perform statistical tests of velocity between conditions. - The ability to convert velocity estimates to a “real” time scale.</p>
<p>Comparing cell cycle velocities might be useful in a variable of scientific contexts: - Do two cancer subtumors proliferate as similar speeds? - Does a particular gene knockout or mutant impact the cell cycle speed? - Do progenitor cells in different regions of an organ (i.e., brain) or at different developmental stages divide equally quickly?</p>
<p>Here, we will offer a short tutorial into VeloCycle, using the ductal cells from the pancreas dataset above. This will also offer insight into probabilistic modeling in Pyro, which is an advanced method used by many tools for modeling complex biological data.</p>
<div id="640dae02-20e1-4919-a3d4-9df7e0d0b7fc" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> velocycle <span class="im">as</span> vcy</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> velocycle <span class="im">import</span> <span class="op">*</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> anndata</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyro</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="41dd00c3-fe3c-44b0-b6df-1ffe4914122d" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>adata_raw <span class="op">=</span> scv.datasets.pancreas()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>adata_cycling <span class="op">=</span> adata_raw[adata_raw.obs[<span class="st">"clusters"</span>].isin([<span class="st">"Ductal"</span>])].copy()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>adata_cycling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>AnnData object with n_obs × n_vars = 916 × 27998
    obs: 'clusters_coarse', 'clusters', 'S_score', 'G2M_score'
    var: 'highly_variable_genes'
    uns: 'clusters_coarse_colors', 'clusters_colors', 'day_colors', 'neighbors', 'pca'
    obsm: 'X_pca', 'X_umap'
    layers: 'spliced', 'unspliced'
    obsp: 'distances', 'connectivities'</code></pre>
</div>
</div>
<p>import velocycle as vc from velocycle import *</p>
</section>
<section id="generic-ml" class="level1">
<h1>generic &amp; ml</h1>
<p>import numpy as np import pandas as pd import matplotlib.pyplot as plt import torch import pyro import copy import scipy import pycircstat import pickle</p>
</section>
<section id="scrna-seq" class="level1">
<h1>scRNA-seq</h1>
<p>import scanpy as sc import anndata</p>
<p>from threadpoolctl import threadpool_limits threadpool_limits(limits=8)</p>
<p>import matplotlib as mpl mpl.rcParams[‘pdf.fonttype’] = 42</p>
<p>USE_GPU = True if USE_GPU and torch.cuda.is_available(): print(“Will use GPU”) device = torch.device(“cuda:0”) else: print(“Will use CPU”) device = torch.device(“cpu”)</p>
<section id="load-and-filter-dataset" class="level2">
<h2 class="anchored" data-anchor-id="load-and-filter-dataset">Load and filter dataset</h2>
<div id="cda77d98-f06b-4d8a-8aef-5db3cb195021" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> adata_cycling.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4be6c14b-10d4-4a3f-8815-05ab8d726a2f" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, color<span class="op">=</span><span class="st">'clusters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1f16014a" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>full_adatas <span class="op">=</span> {<span class="st">"pancreas_ductal"</span>:adata[adata.obs[<span class="st">"clusters"</span>].isin([<span class="st">"Ductal"</span>])].copy()}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1a395701-940e-4c3f-93fb-a385bf6ead43" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter lowly-expressed genes and concatenate all datasets</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a <span class="kw">in</span> full_adatas.keys(): </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(full_adatas[a].shape)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    sc.pp.filter_genes(full_adatas[a], min_cells<span class="op">=</span><span class="bu">int</span>((full_adatas[a].n_obs)<span class="op">*</span><span class="fl">0.10</span>))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> anndata.concat(full_adatas, label<span class="op">=</span><span class="st">"batch"</span>, join <span class="op">=</span><span class="st">"outer"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(916, 7159)</code></pre>
</div>
</div>
<div id="51a4e25e-cfcd-4390-bc80-41096e71c699" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform some very basic gene filtering by unspliced counts</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[:, (data.layers[<span class="st">"unspliced"</span>].toarray().mean(<span class="dv">0</span>) <span class="op">&gt;</span> <span class="fl">0.1</span>)].copy()</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform some very basic gene filtering by spliced counts</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[:, data.layers[<span class="st">"spliced"</span>].toarray().mean(<span class="dv">0</span>) <span class="op">&gt;</span> <span class="fl">0.2</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="876d339a-bf0e-455c-bdd0-043e37b662f2" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>data.var.index <span class="op">=</span> [i.upper() <span class="cf">for</span> i <span class="kw">in</span> data.var.index]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>AnnData object with n_obs × n_vars = 916 × 1394
    obs: 'clusters_coarse', 'clusters', 'S_score', 'G2M_score', 'batch'
    obsm: 'X_pca', 'X_umap'
    layers: 'spliced', 'unspliced'</code></pre>
</div>
</div>
<div id="a22edbbc-71e9-4c02-a962-0c195655f94b" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create design matrix for dataset with a single batch</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>batch_design_matrix <span class="op">=</span> preprocessing.make_design_matrix(data, ids<span class="op">=</span><span class="st">"batch"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8d011414-b96a-45b3-b8ea-dc551d1e8a02" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rough approximation of the cell cycle phase using categorical approaches </span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>sc.tl.score_genes_cell_cycle(data, s_genes<span class="op">=</span>utils.S_genes_human, g2m_genes<span class="op">=</span>utils.G2M_genes_human)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING: genes are not in var_names and ignored: ['BLM', 'BRIP1', 'CASP8AP2', 'CCNE2', 'CDC45', 'CDC6', 'CDCA7', 'CHAF1B', 'CLSPN', 'DSCC1', 'DTL', 'E2F8', 'EXO1', 'FEN1', 'GINS2', 'GMNN', 'MCM2', 'MCM4', 'MCM5', 'MCM6', 'MLF1IP', 'MSH2', 'PCNA', 'POLD3', 'RAD51', 'RAD51AP1', 'RPA2', 'RRM1', 'RRM2', 'SLBP', 'UBR7', 'UHRF1', 'UNG', 'USP1', 'WDR76']
WARNING: genes are not in var_names and ignored: ['ANLN', 'AURKA', 'AURKB', 'BIRC5', 'BUB1', 'CCNB2', 'CDC20', 'CDC25C', 'CDCA3', 'CDCA8', 'CENPA', 'CENPF', 'CKAP2L', 'CKS1B', 'CTCF', 'DLGAP5', 'ECT2', 'FAM64A', 'G2E3', 'GAS2L3', 'GTSE1', 'HJURP', 'HMGB2', 'HMMR', 'HN1', 'KIF20B', 'KIF2C', 'LBR', 'MKI67', 'NDC80', 'NEK2', 'NUF2', 'PSRC1', 'TACC3', 'TMPO', 'TTK', 'TUBB4B', 'UBE2C']</code></pre>
</div>
</div>
<div id="6e41bbe1" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create size-normalized data layers</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>preprocessing.normalize_total(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f1d3abcb-14ef-4938-8268-94dc8c7f40c2" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get biologically-relevant gene set to use for velocity estimation</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>full_keep_genes <span class="op">=</span> utils.get_cycling_gene_set(size<span class="op">=</span><span class="st">"Medium"</span>, species<span class="op">=</span><span class="st">"Human"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="initialize-cycle-and-phase-objects-with-priors" class="level1">
<h1>Initialize cycle and phase objects with priors</h1>
<div id="49bfffd1-8469-49e2-a2ac-a239424deb3f" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>n_harm <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>cycle_prior <span class="op">=</span> cycle.Cycle.trivial_prior(gene_names<span class="op">=</span>full_keep_genes, harmonics<span class="op">=</span>n_harm)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>cycle_prior, data_to_fit <span class="op">=</span> preprocessing.filter_shared_genes(cycle_prior, data, filter_type<span class="op">=</span><span class="st">"intersection"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8d180b2c-8f91-4c45-a0ee-7e55269d7620" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the priors for gene harmonics</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to gene-specific means and stds</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> data_to_fit.layers[<span class="st">'spliced'</span>].toarray()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>S_means <span class="op">=</span> S.mean(axis<span class="op">=</span><span class="dv">0</span>) <span class="co">#sum over cells</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>nu0 <span class="op">=</span> np.log(S_means)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>nu0std <span class="op">=</span> np.std(np.log(S<span class="op">+</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>S_frac_means<span class="op">=</span>np.vstack((nu0, <span class="dv">0</span><span class="op">*</span>nu0, <span class="dv">0</span><span class="op">*</span>nu0))</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>cycle_prior.set_means(S_frac_means)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>S_frac_stds<span class="op">=</span>np.vstack((nu0std, <span class="fl">0.5</span><span class="op">*</span>nu0std, <span class="fl">0.5</span><span class="op">*</span>nu0std))</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>cycle_prior.set_stds(S_frac_stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d7b68817-2859-4779-be83-11d33420f4db" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>OFFSET<span class="op">=</span><span class="dv">1</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'fraction of UMI for each gene'</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>ax.hist(np.log10(data_to_fit.layers[<span class="st">'S_sz'</span>].flatten()<span class="op">+</span>OFFSET), bins <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"log10(S_sz)"</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"frequency"</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b8c8b690-2642-4f8b-8940-98180666f3ce" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain a PCA prior for individual cell phases</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>phase_prior <span class="op">=</span> phases.Phases.from_pca_heuristic(data_to_fit, </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                                               concentration<span class="op">=</span><span class="fl">5.0</span>, </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>                                               plot<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>                                               small_count<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-48-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2048bc2d-b919-4763-859a-9b4cc23b78a6" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift the phase prior to have maximum correlation with the total raw UMI counts</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>(shift, maxcor, allcor) <span class="op">=</span> phase_prior.max_corr(data_to_fit.obs.n_scounts)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>phase_prior.rotate(angle<span class="op">=-</span>shift)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>plt.plot(phase_prior.phis, data_to_fit.obs.n_scounts, <span class="st">'.'</span>, c<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, np.pi<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, np.pi, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π"</span>, <span class="st">"2π"</span>])</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"PCA Phase Prior"</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Raw Spliced UMIs"</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="run-the-manifold-learning-module" class="level2">
<h2 class="anchored" data-anchor-id="run-the-manifold-learning-module">Run the manifold-learning module</h2>
<div id="943cbc52-8475-4dd1-acb2-83c274776824" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>pyro.clear_param_store()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c7b94dac-4c9e-4f41-b840-7f7f77366a07" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set batch effect to zero because there is only a single dataset/batch</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>Δν <span class="op">=</span> torch.zeros((batch_design_matrix.shape[<span class="dv">1</span>], S.shape[<span class="dv">1</span>], <span class="dv">1</span>)).<span class="bu">float</span>()</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>condition_on_dict <span class="op">=</span> {<span class="st">"Δν"</span>: Δν}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2e440ed8-f787-4952-aeee-ab84a34ba1b4" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>metapar <span class="op">=</span> preprocessing.preprocess_for_phase_estimation(anndata<span class="op">=</span>data_to_fit, </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                                          cycle_obj<span class="op">=</span>cycle_prior, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                                          phase_obj<span class="op">=</span>phase_prior, </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                                          design_mtx<span class="op">=</span>batch_design_matrix,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                                          n_harmonics<span class="op">=</span>n_harm,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                                          condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fadb120e-071b-4548-a44f-90c6a93f61c2" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>phase_fit <span class="op">=</span> phase_inference_model.PhaseFitModel(metaparams<span class="op">=</span>metapar, </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                                                condition_on<span class="op">=</span>condition_on_dict)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>phase_fit.check_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Trace Shapes:                          
  Param Sites:                          
 Sample Sites:                          
    cells dist            |             
         value        916 |             
    genes dist            |             
         value         61 |             
  batches dist            |             
         value          1 |             
        ν dist     61   1 |   3         
         value     61   1 |   3         
       Δν dist   1 61   1 |             
         value   1 61   1 |             
      ϕxy dist        916 |   2         
         value        916 |   2         
        ϕ dist            | 916         
         value            | 916         
        ζ dist            | 916 3       
         value            | 916 3       
    ElogS dist            |   1 1 61 916
         value            |   1 1 61 916
shape_inv dist     61   1 |             
         value     61   1 |             
        S dist 1 1 61 916 |             
         value     61 916 |             </code></pre>
</div>
</div>
<div id="4b181420-d4e2-48b2-bb96-3e7d85c66061" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>initial_lr <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>final_lr <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> final_lr <span class="op">/</span> initial_lr</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>lrd <span class="op">=</span> gamma <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> num_steps)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>adam <span class="op">=</span> pyro.optim.ClippedAdam({<span class="st">'lr'</span>: initial_lr, <span class="st">'lrd'</span>: lrd, <span class="st">'betas'</span>: (<span class="fl">0.80</span>, <span class="fl">0.99</span>)})</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>phase_fit.fit(optimizer<span class="op">=</span>adam, num_steps<span class="op">=</span>num_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-54-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualize-the-results" class="level2">
<h2 class="anchored" data-anchor-id="visualize-the-results">Visualize the results</h2>
<div id="fff35d9a-78c4-4dac-8891-98832edad085" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put estimations in new objects</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>cycle_pyro <span class="op">=</span> phase_fit.cycle_pyro</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>phase_pyro <span class="op">=</span> phase_fit.phase_pyro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d731f7df-41db-4a7f-86a0-a36a4817af5e" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fit_ElogS <span class="op">=</span> phase_fit.posterior[<span class="st">"ElogS"</span>].squeeze().numpy()</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>fit_ElogS2 <span class="op">=</span> phase_fit.posterior[<span class="st">"ElogS2"</span>].squeeze().numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0b5f7a25-2419-420b-a27d-09ea5ae39c13" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>name2color <span class="op">=</span> {<span class="st">'G1'</span>:<span class="st">"tab:blue"</span>, <span class="st">'S'</span>:<span class="st">"tab:orange"</span>, <span class="st">'G2M'</span>:<span class="st">"tab:green"</span>}</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>gene_list <span class="op">=</span> [<span class="st">"CDK1"</span>, <span class="st">"HELLS"</span>, <span class="st">"SON"</span>, <span class="st">"TOP2A"</span>, <span class="st">"HAT1"</span>]</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(data_to_fit.var.index)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="va">None</span>,(<span class="dv">24</span>, <span class="dv">4</span>))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(gene_list)):</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> gene_list[i]</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="bu">len</span>(gene_list), ix)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    plt.scatter(phase_pyro.phis, </span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>                metapar.S[np.where(gene_names<span class="op">==</span>g)[<span class="dv">0</span>][<span class="dv">0</span>], :].squeeze().cpu().numpy(), </span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>                s<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, c<span class="op">=</span>[name2color[x] <span class="cf">for</span> x <span class="kw">in</span> data_to_fit.obs[<span class="st">"phase"</span>]])</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    plt.scatter(phase_pyro.phis, </span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>                np.exp(fit_ElogS2[np.where(gene_names<span class="op">==</span>g)[<span class="dv">0</span>][<span class="dv">0</span>], :]), </span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>                s<span class="op">=</span><span class="dv">10</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    plt.title(g)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"ϕ"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"counts"</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    ix<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    plt.xticks([<span class="dv">0</span>, np.pi<span class="op">/</span><span class="dv">2</span>, np.pi, <span class="dv">3</span><span class="op">*</span>np.pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π/2"</span>, <span class="st">"π"</span>, <span class="st">"3π/2"</span>, <span class="st">"2π"</span>])</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    plt.xlim(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8dc6198e-d74d-48ee-a3c4-d10580faf951" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">1</span>]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">2</span>]</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> np.log10( np.sqrt(xs<span class="op">**</span><span class="dv">2</span><span class="op">+</span>ys<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> phase_fit.fourier_coef_sd[<span class="dv">1</span>:, :].<span class="bu">sum</span>(<span class="dv">0</span>) )</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> np.arctan2(xs, ys)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> (angle)<span class="op">%</span>(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>phis_df <span class="op">=</span> pd.DataFrame([angle, r])</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>phis_df.columns <span class="op">=</span> data_to_fit.var.index</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>phase_data_frame <span class="op">=</span> pd.concat([phase_fit.cycle_pyro.means, phase_fit.cycle_pyro.stds, phis_df]).T</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>phase_data_frame.columns <span class="op">=</span> [<span class="st">"nu0 mean"</span>, <span class="st">"nu1sin mean"</span>, <span class="st">"nu1cos mean"</span>,</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"nu0 std"</span>, <span class="st">"nu1sin std"</span>, <span class="st">"nu1cos std"</span>, <span class="st">"peak_phase"</span>, <span class="st">"amplitude"</span>]</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>phase_data_frame[<span class="st">"is_seurat_marker"</span>] <span class="op">=</span> [<span class="va">True</span> <span class="cf">if</span> i <span class="kw">in</span> <span class="bu">list</span>(utils.S_genes_human)<span class="op">+</span><span class="bu">list</span>(utils.G2M_genes_human) <span class="cf">else</span> <span class="va">False</span> <span class="cf">for</span> i <span class="kw">in</span> phase_data_frame.index]</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>phase_data_frame.head()</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>phis_df <span class="op">=</span> pd.DataFrame(phase_fit.phase_pyro.phis.numpy())</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>phis_df.index <span class="op">=</span> data_to_fit.obs.index</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>phis_df.columns <span class="op">=</span> [<span class="st">"cell_cycle_phi"</span>]</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>phase_data_frame_cells <span class="op">=</span> data_to_fit.obs.merge(phis_df, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f8e262ff-2789-4e66-b9c7-9b6d07d5a670" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of bins</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>num_bins <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>bin_width <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> num_bins</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the bin index for each gene</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>phase_data_frame[<span class="st">'bin_index'</span>] <span class="op">=</span> ((phase_data_frame[<span class="st">'peak_phase'</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">%</span> (<span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">/</span> bin_width).astype(<span class="bu">int</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Group genes by bin index and find top 10 genes in each bin</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>top_genes_per_bin <span class="op">=</span> phase_data_frame.groupby(<span class="st">'bin_index'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> group: group.nlargest(<span class="dv">5</span>, <span class="st">'amplitude'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="53ff955f-8a63-4b97-94c2-2fc4a9ad097f" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="op">=</span> [a.upper() <span class="cf">for</span> a <span class="kw">in</span> cycle_prior.means.columns]</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(keep_genes)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap, LinearSegmentedColormap</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.transforms <span class="im">as</span> mtransforms</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cmcrameri <span class="im">import</span> cm</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="op">=</span> [a.upper() <span class="cf">for</span> a <span class="kw">in</span> cycle_prior.means.columns]</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(keep_genes)</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>S_genes_human <span class="op">=</span> <span class="bu">list</span>(utils.S_genes_human)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>G2M_genes_human <span class="op">=</span> <span class="bu">list</span>(utils.G2M_genes_human)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>phases_list <span class="op">=</span> [S_genes_human, G2M_genes_human, [i.upper() <span class="cf">for</span> i <span class="kw">in</span> gene_names <span class="cf">if</span> i.upper() <span class="kw">not</span> <span class="kw">in</span> S_genes_human<span class="op">+</span>G2M_genes_human]]</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> []</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>gradient <span class="op">=</span> []</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(phases_list)):</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(phases_list[i])):</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        g.append(phases_list[i][j])</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>        gradient.append(i)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>color_gradient_map <span class="op">=</span> pd.DataFrame({<span class="st">'Gene'</span>: g,  <span class="st">'Color'</span>: gradient}).set_index(<span class="st">'Gene'</span>).to_dict()[<span class="st">'Color'</span>]</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>colored_gradient <span class="op">=</span> pd.Series(gene_names).<span class="bu">map</span>(color_gradient_map)</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">1</span>]</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">2</span>]</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> np.log10( np.sqrt(xs<span class="op">**</span><span class="dv">2</span><span class="op">+</span>ys<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> phase_fit.fourier_coef_sd[<span class="dv">1</span>:, :].<span class="bu">sum</span>(<span class="dv">0</span>) )</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> np.arctan2(xs, ys)</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> (angle)<span class="op">%</span>(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">50</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">/</span> N</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize <span class="op">=</span> (<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(projection<span class="op">=</span><span class="st">'polar'</span>)</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a><span class="co"># First: only plot dots with a color assignment</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> colored_gradient.values[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove genes with very low expression</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> color_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>gene_names_subset <span class="op">=</span> gene_names[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span><span class="dv">100</span></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a subset of most highly expressing genes to print the names </span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>angle_subset_best <span class="op">=</span> angle_subset[r_subset<span class="op">&gt;</span>np.percentile(r_subset, x)]</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>color_subset_best <span class="op">=</span> color_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>gene_names_subset_best <span class="op">=</span> gene_names_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>r_subset_best <span class="op">=</span> r_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot all genes in phases list</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>num2color <span class="op">=</span> {<span class="dv">0</span>:<span class="st">"tab:orange"</span>, <span class="dv">1</span>:<span class="st">"tab:green"</span>, <span class="dv">2</span>:<span class="st">"tab:grey"</span>, <span class="dv">3</span>:<span class="st">"tab:blue"</span>}</span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a>ax.scatter(angle_subset, r_subset, c<span class="op">=</span>[num2color[i] <span class="cf">for</span> i <span class="kw">in</span> color_subset], s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>, rasterized<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Select and plot on top the genes marking S and G2M traditionally</span></span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>gene_names_subset <span class="op">=</span> gene_names_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> color_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a>ax.scatter(angle_subset, r_subset, c<span class="op">=</span>[num2color[i] <span class="cf">for</span> i <span class="kw">in</span> color_subset], s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="dv">1</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>,rasterized<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate genes</span></span>
<span id="cb76-69"><a href="#cb76-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i, txt), c <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">enumerate</span>(gene_names), colored_gradient.values):</span>
<span id="cb76-70"><a href="#cb76-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> txt <span class="kw">in</span> top_genes_per_bin.index:</span>
<span id="cb76-71"><a href="#cb76-71" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> np.where(np.array(gene_names)<span class="op">==</span>txt)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb76-72"><a href="#cb76-72" aria-hidden="true" tabindex="-1"></a>        ax.annotate(txt[<span class="dv">0</span>]<span class="op">+</span>txt[<span class="dv">1</span>:].upper(), (angle[ix], r[ix]<span class="op">+</span><span class="fl">0.02</span>))</span>
<span id="cb76-73"><a href="#cb76-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-74"><a href="#cb76-74" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb76-75"><a href="#cb76-75" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">1</span>, )</span>
<span id="cb76-76"><a href="#cb76-76" aria-hidden="true" tabindex="-1"></a>plt.yticks([<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], size<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb76-77"><a href="#cb76-77" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, np.pi<span class="op">/</span><span class="dv">2</span>, np.pi, <span class="dv">3</span><span class="op">*</span>np.pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π/2"</span>, <span class="st">"π"</span>, <span class="st">"3π/2"</span>, <span class="st">"2π"</span>], size<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb76-78"><a href="#cb76-78" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb76-79"><a href="#cb76-79" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-60-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="run-the-velocity-learning-module" class="level2">
<h2 class="anchored" data-anchor-id="run-the-velocity-learning-module">Run the velocity-learning module</h2>
<div id="04750e12-6dd2-4ffe-b46f-062b62c95e94" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>pyro.clear_param_store()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ecde69a7-56fc-454a-8266-ac79ef34da88" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>condition_design_matrix <span class="op">=</span> copy.deepcopy(batch_design_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e970d2c0-283a-44fd-b4b0-29348297d468" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>n_velo_harmonics <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>speed_prior <span class="op">=</span> angularspeed.AngularSpeed.trivial_prior(condition_names<span class="op">=</span>[<span class="st">"pancreas_ductal"</span>], </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                                                      harmonics<span class="op">=</span>n_velo_harmonics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ab7d8ad8-e666-4fcc-8ef2-507696728997" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>condition_on_dict <span class="op">=</span> {<span class="st">"ϕxy"</span>:phase_pyro.phi_xy_tensor.T,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"ν"</span>: cycle_pyro.means_tensor.T.unsqueeze(<span class="op">-</span><span class="dv">2</span>),</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Δν"</span>: torch.tensor(phase_fit.delta_nus),</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"shape_inv"</span>: torch.tensor(phase_fit.disp_pyro).unsqueeze(<span class="op">-</span><span class="dv">1</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="afd51dc4-183f-4f91-b7dc-cab1f55214e8" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>metaparameters_velocity <span class="op">=</span> preprocessing.preprocess_for_velocity_estimation(data_to_fit, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                                                             cycle_pyro, </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>                                                             phase_pyro, </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>                                                             speed_prior,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                                                             condition_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                                                             batch_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>                                                             n_harmonics<span class="op">=</span>n_harm,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>                                                             count_factor<span class="op">=</span>metapar.count_factor,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>                                                             ω_n_harmonics<span class="op">=</span>n_velo_harmonics, </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>                                                             μγ<span class="op">=</span>torch.tensor(<span class="fl">0.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>                                                             σγ<span class="op">=</span>torch.tensor(<span class="fl">0.5</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>                                                             μβ<span class="op">=</span>torch.tensor(<span class="fl">2.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>                                                             σβ<span class="op">=</span>torch.tensor(<span class="fl">3.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>                                                             model_type<span class="op">=</span><span class="st">"lrmn"</span>,</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>                                                             condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6194bf6e" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>velocity_fit <span class="op">=</span> velocity_inference_model.VelocityFitModel(metaparams<span class="op">=</span>metaparameters_velocity, </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                                                         condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="eadf1d06-d8cd-486a-9d67-ab88d05f62e2" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>velocity_fit.check_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Trace Shapes:                              
   Param Sites:                              
  Sample Sites:                              
     cells dist              |               
          value          916 |               
     genes dist              |               
          value           61 |               
 harmonics dist              |               
          value            1 |               
conditions dist              |               
          value            1 |               
   batches dist              |               
          value            1 |               
     logγg dist       61   1 |               
          value       61   1 |               
     logβg dist       61   1 |               
          value       61   1 |               
  rho_real dist       61   1 |               
          value       61   1 |               
        γg dist       61   1 |  61   1       
          value              |  61   1       
         ν dist       61   1 |   3           
          value       61   1 |   3           
        Δν dist 1 1 1 61   1 |               
          value 1 1 1 61   1 |               
       ϕxy dist          916 |   2           
          value          916 |   2           
         ϕ dist              | 916           
          value              | 916           
         ζ dist              | 916   3       
          value              | 916   3       
      ζ_dϕ dist              | 916   3       
          value              | 916   3       
        νω dist   1 1  1   1 |               
          value   1 1  1   1 |               
        ζω dist              |   1 916       
          value              |   1 916       
     ElogS dist              |   1   1 61 916
          value              |   1   1 61 916
         ω dist              |   1 916       
          value              |   1 916       
     ElogU dist              |   1   1 61 916
          value              |   1   1 61 916
 shape_inv dist       61   1 |               
          value       61   1 |               
         S dist   1 1 61 916 |               
          value       61 916 |               
         U dist   1 1 61 916 |               
          value       61 916 |               </code></pre>
</div>
</div>
<div id="3abe1777-d2ea-4816-b1f7-4734ce098100" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>velocity_fit.check_guide()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Trace Shapes:              
   Param Sites:              
         ν_locs     61   1  3
       ν_scales     61   1  3
        Δν_locs 1 1  1  61  1
       ϕxy_locs        916  2
     logβg_locs         61  1
   logβg_scales         61  1
            loc            62
     cov_factor         62  5
       cov_diag            62
   rho_real_loc            61
 shape_inv_locs         61  1
  Sample Sites:              
     cells dist             |
          value        916  |
     genes dist             |
          value         61  |
 harmonics dist             |
          value          1  |
conditions dist             |
          value          1  |
   batches dist             |
          value          1  |
     logγg dist     61   1  |
          value     61   1  |
  rho_real dist     61   1  |
          value     61   1  |
     logβg dist     61   1  |
          value     61   1  |
        νω dist 1 1  1   1  |
          value 1 1  1   1  |</code></pre>
</div>
</div>
<div id="199e5e5a" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>initial_lr <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>final_lr <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> final_lr <span class="op">/</span> initial_lr</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>lrd <span class="op">=</span> gamma <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> num_steps)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>adam <span class="op">=</span> pyro.optim.ClippedAdam({<span class="st">'lr'</span>: initial_lr, <span class="st">'lrd'</span>: lrd, <span class="st">'betas'</span>: (<span class="fl">0.80</span>, <span class="fl">0.99</span>)})</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>velocity_fit.fit(optimizer<span class="op">=</span>adam, num_steps<span class="op">=</span>num_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-69-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1b98be4c-e158-4117-91c6-63a3031e9707" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put estimations in new objects</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>cycle_pyro <span class="op">=</span> velocity_fit.cycle_pyro</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>phase_pyro <span class="op">=</span> velocity_fit.phase_pyro</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>speed_pyro <span class="op">=</span> velocity_fit.speed_pyro</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>fit_ElogS <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS"</span>].squeeze()</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>fit_ElogU <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU"</span>].squeeze()</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>fit_ElogS2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS2"</span>].squeeze()</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>fit_ElogU2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU2"</span>].squeeze()</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>log_gammas <span class="op">=</span> velocity_fit.log_gammas</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>log_betas <span class="op">=</span> velocity_fit.log_betas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1a2568bc-778d-4949-b3c8-f1d2f7d642b4" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store entire posterior sampling into an object</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>full_pps_velo <span class="op">=</span> velocity_fit.posterior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="be116f83-63bd-41f6-b283-1e8bd64c8bfe" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See the value of the mean gamma</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>array(1.0223038, dtype=float32)</code></pre>
</div>
</div>
<div id="076349fe-1502-4185-9ceb-c9e8491b8d15" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the constant velocity estimate</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>omega <span class="op">=</span> full_pps_velo[<span class="st">"ω"</span>].squeeze().numpy() <span class="op">/</span> torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> phase_pyro.phis</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>omegas <span class="op">=</span> []</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>phis <span class="op">=</span> []</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>n2n <span class="op">=</span> {<span class="st">"pancreas_ductal"</span>:<span class="dv">0</span>}</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> np.array([n2n[i] <span class="cf">for</span> i <span class="kw">in</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>])])</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data_to_fit.obs[<span class="st">"batch"</span>].unique())):</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    omega1 <span class="op">=</span> omega[:,np.where(ids <span class="op">==</span> i)]</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    phi1 <span class="op">=</span> phi[np.where(ids <span class="op">==</span> i)]</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    omegas.append(omega1)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    phis.append(phi1)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>].unique()) <span class="co">#list(adatas.keys())</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"tab:blue"</span>, <span class="st">"tab:orange"</span>, <span class="st">"tab:green"</span>, <span class="st">"tab:red"</span>]</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(omegas)):</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    plt.plot(phis[i][np.argsort(phis[i])], omegas[i].mean(<span class="dv">0</span>)[<span class="dv">0</span>][np.argsort(phis[i])], c<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>)</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    tmp5 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    tmp95 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">95</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).mean(), ((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).std())</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    phi_i <span class="op">=</span> phi[ids<span class="op">==</span>i] </span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(x<span class="op">=</span>phi_i[np.argsort(phi_i)],</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>                     y1<span class="op">=</span>tmp5[np.argsort(phi_i)], </span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>                     y2<span class="op">=</span>tmp95[np.argsort(phi_i)], </span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span>colors[i], label <span class="op">=</span> labels[i])</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"phase"</span>)</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"omega"</span>)</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.ylim(0.2, 0.5)</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15.7860985 1.1131837</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-73-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e847a93b-2642-433d-b65f-300ddc02bbd0" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>scv.pp.filter_genes(adata_cycling, min_shared_counts<span class="op">=</span><span class="dv">20</span>, min_shared_cells<span class="op">=</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtered out 26117 genes that are detected 20 counts (shared).</code></pre>
</div>
</div>
<div id="ba68ce3f-fb50-4e0c-8f74-2ebbd976ad1e" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>adata_cycling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>AnnData object with n_obs × n_vars = 916 × 1881
    obs: 'clusters_coarse', 'clusters', 'S_score', 'G2M_score', 'initial_size_unspliced', 'initial_size_spliced', 'initial_size'
    var: 'highly_variable_genes'
    uns: 'clusters_coarse_colors', 'clusters_colors', 'day_colors', 'neighbors', 'pca'
    obsm: 'X_pca', 'X_umap'
    layers: 'spliced', 'unspliced'
    obsp: 'distances', 'connectivities'</code></pre>
</div>
</div>
<div id="510f2367" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create design matrix for dataset with a single batch</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>batch_design_matrix <span class="op">=</span> vcy.preprocessing.make_design_matrix(adata_cycling, ids<span class="op">=</span><span class="st">"clusters"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9d15deed" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create size-normalized data layers</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>vcy.preprocessing.normalize_total(adata_cycling)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="53f60616" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get biologically-relevant gene set to use for velocity estimation</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>full_keep_genes <span class="op">=</span> vcy.utils.get_cycling_gene_set(size<span class="op">=</span><span class="st">"Medium"</span>, species<span class="op">=</span><span class="st">"Mouse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="initialize-cycle-and-phase-objects-with-priors-1" class="level1">
<h1>Initialize cycle and phase objects with priors</h1>
<div id="00581ec3" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>n_harm <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>cycle_prior <span class="op">=</span> vcy.cycle.Cycle.trivial_prior(gene_names<span class="op">=</span>full_keep_genes, harmonics<span class="op">=</span>n_harm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cd4c72a6" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only genes from biologically-relevant gene set that are present in current datasets</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>cycle_prior, data_to_fit <span class="op">=</span> vcy.preprocessing.filter_shared_genes(cycle_prior, adata_cycling, filter_type<span class="op">=</span><span class="st">"intersection"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0226de3b" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>data_to_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>AnnData object with n_obs × n_vars = 916 × 90
    obs: 'clusters_coarse', 'clusters', 'S_score', 'G2M_score', 'initial_size_unspliced', 'initial_size_spliced', 'initial_size', 'n_scounts', 'n_ucounts'
    var: 'highly_variable_genes'
    uns: 'clusters_coarse_colors', 'clusters_colors', 'day_colors', 'neighbors', 'pca'
    obsm: 'X_pca', 'X_umap'
    layers: 'spliced', 'unspliced', 'S_sz', 'U_sz'
    obsp: 'distances', 'connectivities'</code></pre>
</div>
</div>
<div id="d3dc3c3b" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the priors for gene harmonics</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to gene-specific means and stds</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> data_to_fit.layers[<span class="st">'spliced'</span>].toarray()</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>S_means <span class="op">=</span> S.mean(axis<span class="op">=</span><span class="dv">0</span>) <span class="co">#sum over cells</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>nu0 <span class="op">=</span> np.log(S_means)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>nu0std <span class="op">=</span> np.std(np.log(S<span class="op">+</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>)<span class="op">/</span><span class="dv">2</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>S_frac_means<span class="op">=</span>np.vstack((nu0, <span class="dv">0</span><span class="op">*</span>nu0, <span class="dv">0</span><span class="op">*</span>nu0))</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>cycle_prior.set_means(S_frac_means)</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>S_frac_stds<span class="op">=</span>np.vstack((nu0std, <span class="fl">0.5</span><span class="op">*</span>nu0std, <span class="fl">0.5</span><span class="op">*</span>nu0std))</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>cycle_prior.set_stds(S_frac_stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="26538234" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain a PCA prior for individual cell phases</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>data_to_fit.layers[<span class="st">"S_sz_log"</span>] <span class="op">=</span> np.log(data_to_fit.layers[<span class="st">"S_sz"</span>]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>phase_prior <span class="op">=</span> vcy.phases.Phases.from_pca_heuristic(data_to_fit, plot<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-83-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="63f582cc" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift the phase prior to have maximum correlation with the total raw UMI counts</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>(shift, maxcor, allcor) <span class="op">=</span> phase_prior.max_corr(data_to_fit.obs.n_scounts)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>phase_prior.rotate(angle<span class="op">=-</span>shift)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>plt.plot(phase_prior.phis, data_to_fit.obs.n_scounts, <span class="st">'.'</span>, c<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, np.pi<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, np.pi, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π"</span>, <span class="st">"2π"</span>])</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"PCA Phase Prior"</span>)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Raw Spliced UMIs"</span>)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-84-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="run-the-manifold-learning-module-1" class="level1">
<h1>Run the manifold-learning module</h1>
<div id="cc839bcf" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>pyro.clear_param_store()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a089a117" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set batch effect to zero because there is only a single dataset/batch</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>Δν <span class="op">=</span> torch.zeros((batch_design_matrix.shape[<span class="dv">1</span>], S.shape[<span class="dv">1</span>], <span class="dv">1</span>)).<span class="bu">float</span>()</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>condition_on_dict <span class="op">=</span> {<span class="st">"Δν"</span>: Δν}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="888db9e0" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>metapar <span class="op">=</span> vcy.preprocessing.preprocess_for_phase_estimation(anndata<span class="op">=</span>data_to_fit, </span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>                                          cycle_obj<span class="op">=</span>cycle_prior, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>                                          phase_obj<span class="op">=</span>phase_prior, </span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>                                          design_mtx<span class="op">=</span>batch_design_matrix,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>                                          gene_selection_model<span class="op">=</span><span class="st">"all"</span>,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>                                          n_harmonics<span class="op">=</span>n_harm,</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>                                          condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="99f4ec40" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>phase_fit <span class="op">=</span> vcy.phase_inference_model.PhaseFitModel(metaparams<span class="op">=</span>metapar, condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b9d5f9e8" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="dv">3000</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>initial_lr <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>final_lr <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> final_lr <span class="op">/</span> initial_lr</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>lrd <span class="op">=</span> gamma <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> num_steps)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>adam <span class="op">=</span> pyro.optim.ClippedAdam({<span class="st">'lr'</span>: initial_lr, <span class="st">'lrd'</span>: lrd, <span class="st">'betas'</span>: (<span class="fl">0.80</span>, <span class="fl">0.99</span>)})</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>phase_fit.fit(optimizer<span class="op">=</span>adam, num_steps<span class="op">=</span>num_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-89-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="visualize-the-results-1" class="level2">
<h2 class="anchored" data-anchor-id="visualize-the-results-1">Visualize the results</h2>
<div id="e1ca9ab5" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put estimations in new objects</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>cycle_pyro <span class="op">=</span> phase_fit.cycle_pyro</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>phase_pyro <span class="op">=</span> phase_fit.phase_pyro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a62774e0" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>fit_ElogS <span class="op">=</span> phase_fit.posterior[<span class="st">"ElogS"</span>].squeeze().numpy()</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>fit_ElogS2 <span class="op">=</span> phase_fit.posterior[<span class="st">"ElogS2"</span>].squeeze().numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bc67ad25-d6dd-49e2-b8b8-390ee5be9173" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>data_to_fit.obs[<span class="st">"phase"</span>] <span class="op">=</span> adata[adata.obs[<span class="st">"clusters"</span>]<span class="op">==</span><span class="st">"Ductal"</span>].obs[<span class="st">"phase"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d83f0c22" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>name2color <span class="op">=</span> {<span class="st">'G1'</span>:<span class="st">"tab:blue"</span>, <span class="st">'S'</span>:<span class="st">"tab:orange"</span>, <span class="st">'G2M'</span>:<span class="st">"tab:green"</span>}</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>gene_list <span class="op">=</span> [<span class="st">"Cdk1"</span>, <span class="st">"Hells"</span>, <span class="st">"Son"</span>, <span class="st">"Top2a"</span>, <span class="st">"Hat1"</span>]</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(data_to_fit.var.index)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>plt.figure(<span class="va">None</span>,(<span class="dv">24</span>, <span class="dv">4</span>))</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>ix <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(gene_list)):</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> gene_list[i]</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="bu">len</span>(gene_list), ix)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    plt.scatter(phase_pyro.phis, </span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>                metapar.S[np.where(gene_names<span class="op">==</span>g)[<span class="dv">0</span>][<span class="dv">0</span>], :].squeeze().cpu().numpy(), </span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>                s<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, c<span class="op">=</span>[name2color[x] <span class="cf">for</span> x <span class="kw">in</span> data_to_fit.obs[<span class="st">"phase"</span>]])</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>    plt.scatter(phase_pyro.phis, </span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>                np.exp(fit_ElogS2[np.where(gene_names<span class="op">==</span>g)[<span class="dv">0</span>][<span class="dv">0</span>], :]), </span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>                s<span class="op">=</span><span class="dv">10</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>    plt.title(g)</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"ϕ"</span>)</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"counts"</span>)</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>    ix<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>    plt.xticks([<span class="dv">0</span>, np.pi<span class="op">/</span><span class="dv">2</span>, np.pi, <span class="dv">3</span><span class="op">*</span>np.pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π/2"</span>, <span class="st">"π"</span>, <span class="st">"3π/2"</span>, <span class="st">"2π"</span>])</span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>    plt.xlim(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-93-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ca21e3d6" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">1</span>]</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">2</span>]</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> np.log10( np.sqrt(xs<span class="op">**</span><span class="dv">2</span><span class="op">+</span>ys<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> phase_fit.fourier_coef_sd[<span class="dv">1</span>:, :].<span class="bu">sum</span>(<span class="dv">0</span>) )</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> np.arctan2(xs, ys)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> (angle)<span class="op">%</span>(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>phis_df <span class="op">=</span> pd.DataFrame([angle, r])</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>phis_df.columns <span class="op">=</span> data_to_fit.var.index</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>phase_data_frame <span class="op">=</span> pd.concat([phase_fit.cycle_pyro.means, phase_fit.cycle_pyro.stds, phis_df]).T</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>phase_data_frame.columns <span class="op">=</span> [<span class="st">"nu0 mean"</span>, <span class="st">"nu1sin mean"</span>, <span class="st">"nu1cos mean"</span>,</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"nu0 std"</span>, <span class="st">"nu1sin std"</span>, <span class="st">"nu1cos std"</span>, <span class="st">"peak_phase"</span>, <span class="st">"amplitude"</span>]</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>phase_data_frame[<span class="st">"is_seurat_marker"</span>] <span class="op">=</span> [<span class="va">True</span> <span class="cf">if</span> i <span class="kw">in</span> <span class="bu">list</span>(vcy.utils.S_genes_human)<span class="op">+</span><span class="bu">list</span>(vcy.utils.G2M_genes_human) <span class="cf">else</span> <span class="va">False</span> <span class="cf">for</span> i <span class="kw">in</span> phase_data_frame.index]</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>phase_data_frame.head()</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>phis_df <span class="op">=</span> pd.DataFrame(phase_fit.phase_pyro.phis.numpy())</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>phis_df.index <span class="op">=</span> data_to_fit.obs.index</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>phis_df.columns <span class="op">=</span> [<span class="st">"cell_cycle_phi"</span>]</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>phase_data_frame_cells <span class="op">=</span> data_to_fit.obs.merge(phis_df, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9cfccb93" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of bins</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>num_bins <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>bin_width <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> num_bins</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the bin index for each gene</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>phase_data_frame[<span class="st">'bin_index'</span>] <span class="op">=</span> ((phase_data_frame[<span class="st">'peak_phase'</span>] <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">%</span> (<span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">/</span> bin_width).astype(<span class="bu">int</span>)</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Group genes by bin index and find top 10 genes in each bin</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>top_genes_per_bin <span class="op">=</span> phase_data_frame.groupby(<span class="st">'bin_index'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> group: group.nlargest(<span class="dv">5</span>, <span class="st">'amplitude'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6b79b2c1" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="op">=</span> [a.upper() <span class="cf">for</span> a <span class="kw">in</span> cycle_prior.means.columns]</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(keep_genes)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap, LinearSegmentedColormap</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.transforms <span class="im">as</span> mtransforms</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cmcrameri <span class="im">import</span> cm</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>keep_genes <span class="op">=</span> [a.upper() <span class="cf">for</span> a <span class="kw">in</span> cycle_prior.means.columns]</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>gene_names <span class="op">=</span> np.array(keep_genes)</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>S_genes_human <span class="op">=</span> <span class="bu">list</span>(vcy.utils.S_genes_human)</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>G2M_genes_human <span class="op">=</span> <span class="bu">list</span>(vcy.utils.G2M_genes_human)</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>phases_list <span class="op">=</span> [S_genes_human, G2M_genes_human, [i.upper() <span class="cf">for</span> i <span class="kw">in</span> gene_names <span class="cf">if</span> i.upper() <span class="kw">not</span> <span class="kw">in</span> S_genes_human<span class="op">+</span>G2M_genes_human]]</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> []</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>gradient <span class="op">=</span> []</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(phases_list)):</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(phases_list[i])):</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>        g.append(phases_list[i][j])</span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>        gradient.append(i)</span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>color_gradient_map <span class="op">=</span> pd.DataFrame({<span class="st">'Gene'</span>: g,  <span class="st">'Color'</span>: gradient}).set_index(<span class="st">'Gene'</span>).to_dict()[<span class="st">'Color'</span>]</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>colored_gradient <span class="op">=</span> pd.Series(gene_names).<span class="bu">map</span>(color_gradient_map)</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">1</span>]</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> phase_fit.fourier_coef[<span class="dv">2</span>]</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> np.log10( np.sqrt(xs<span class="op">**</span><span class="dv">2</span><span class="op">+</span>ys<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> phase_fit.fourier_coef_sd[<span class="dv">1</span>:, :].<span class="bu">sum</span>(<span class="dv">0</span>) )</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> np.arctan2(xs, ys)</span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> (angle)<span class="op">%</span>(<span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>N<span class="op">=</span><span class="dv">50</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>np.pi) <span class="op">/</span> N</span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize <span class="op">=</span> (<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(projection<span class="op">=</span><span class="st">'polar'</span>)</span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a><span class="co"># First: only plot dots with a color assignment</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> colored_gradient.values[<span class="op">~</span>np.isnan(colored_gradient.values)]</span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove genes with very low expression</span></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> color_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>gene_names_subset <span class="op">=</span> gene_names[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r_subset[r_subset<span class="op">&gt;=-</span><span class="dv">12</span>]</span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span><span class="dv">100</span></span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a subset of most highly expressing genes to print the names </span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>angle_subset_best <span class="op">=</span> angle_subset[r_subset<span class="op">&gt;</span>np.percentile(r_subset, x)]</span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>color_subset_best <span class="op">=</span> color_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a>gene_names_subset_best <span class="op">=</span> gene_names_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>r_subset_best <span class="op">=</span> r_subset[r_subset<span class="op">&gt;=</span>np.percentile(r_subset, x)]</span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot all genes in phases list</span></span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>num2color <span class="op">=</span> {<span class="dv">0</span>:<span class="st">"tab:orange"</span>, <span class="dv">1</span>:<span class="st">"tab:green"</span>, <span class="dv">2</span>:<span class="st">"tab:grey"</span>}</span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a>ax.scatter(angle_subset, r_subset, c<span class="op">=</span>[num2color[i] <span class="cf">for</span> i <span class="kw">in</span> color_subset], s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>, rasterized<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Select and plot on top the genes marking S and G2M traditionally</span></span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>angle_subset <span class="op">=</span> angle_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>r_subset <span class="op">=</span> r_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>gene_names_subset <span class="op">=</span> gene_names_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>color_subset <span class="op">=</span> color_subset[color_subset<span class="op">!=</span><span class="dv">2</span>]</span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>ax.scatter(angle_subset, r_subset, c<span class="op">=</span>[num2color[i] <span class="cf">for</span> i <span class="kw">in</span> color_subset], s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="dv">1</span>, edgecolor<span class="op">=</span><span class="st">'none'</span>,rasterized<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotate genes</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i, txt), c <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">enumerate</span>(gene_names), colored_gradient.values):</span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> txt <span class="kw">in</span> top_genes_per_bin.index:</span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> np.where(np.array(gene_names)<span class="op">==</span>txt)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>        ax.annotate(txt[<span class="dv">0</span>]<span class="op">+</span>txt[<span class="dv">1</span>:].upper(), (angle[ix], r[ix]<span class="op">+</span><span class="fl">0.02</span>))</span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi)</span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">1</span>, )</span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a>plt.yticks([<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>], size<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, np.pi<span class="op">/</span><span class="dv">2</span>, np.pi, <span class="dv">3</span><span class="op">*</span>np.pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">2</span><span class="op">*</span>np.pi],[<span class="st">"0"</span>, <span class="st">"π/2"</span>, <span class="st">"π"</span>, <span class="st">"3π/2"</span>, <span class="st">"2π"</span>], size<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-96-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0feddeaa" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> phase_fit.metaparams</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> phase_fit.metaparams_avg</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co">#pickle.dump(phase_fit, open("pickle_result_outputs/IrinaFibro_Med_phase_fit_03042024.pkl", "wb"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="run-the-velocity-learning-module-1" class="level1">
<h1>Run the velocity-learning module</h1>
<div id="b46305aa" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>pyro.clear_param_store()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ac9c6b3b" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>condition_design_matrix <span class="op">=</span> copy.deepcopy(batch_design_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fa1b2993" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>speed_prior <span class="op">=</span> vcy.angularspeed.AngularSpeed.trivial_prior(condition_names<span class="op">=</span>[<span class="st">"pancreas_ductal"</span>], harmonics<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="38d1f3e5" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>condition_on_dict <span class="op">=</span> {<span class="st">"ϕxy"</span>:phase_pyro.phi_xy_tensor.T,</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"ν"</span>: cycle_pyro.means_tensor.T.unsqueeze(<span class="op">-</span><span class="dv">2</span>),</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Δν"</span>: torch.tensor(phase_fit.delta_nus),</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"shape_inv"</span>: torch.tensor(phase_fit.disp_pyro).unsqueeze(<span class="op">-</span><span class="dv">1</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0c413537" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>metaparameters_velocity <span class="op">=</span> vcy.preprocessing.preprocess_for_velocity_estimation(data_to_fit, </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>                                                             cycle_pyro, </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>                                                             phase_pyro, </span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>                                                             speed_prior,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>                                                             condition_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                                                             batch_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>                                                             n_harmonics<span class="op">=</span>n_harm,</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>                                                             count_factor<span class="op">=</span>metapar.count_factor,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>                                                             ω_n_harmonics<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>                                                             μγ<span class="op">=</span>torch.tensor(<span class="fl">0.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>                                                             σγ<span class="op">=</span>torch.tensor(<span class="fl">0.5</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>                                                             μβ<span class="op">=</span>torch.tensor(<span class="fl">2.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>                                                             σβ<span class="op">=</span>torch.tensor(<span class="fl">3.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>                                                             model_type<span class="op">=</span><span class="st">"lrmn"</span>,</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>                                                             rho_mean<span class="op">=</span>torch.tensor(<span class="fl">4.0</span>),</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>                                                             rho_rank<span class="op">=</span>torch.tensor(<span class="dv">5</span>),</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>                                                             condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f57c6bdc" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>velocity_fit <span class="op">=</span> vcy.velocity_inference_model.VelocityFitModel(metaparams<span class="op">=</span>metaparameters_velocity, condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bbc65291" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>initial_lr <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>final_lr <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> final_lr <span class="op">/</span> initial_lr</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>lrd <span class="op">=</span> gamma <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> num_steps)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>adam <span class="op">=</span> pyro.optim.ClippedAdam({<span class="st">'lr'</span>: initial_lr, <span class="st">'lrd'</span>: lrd, <span class="st">'betas'</span>: (<span class="fl">0.80</span>, <span class="fl">0.99</span>)})</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>velocity_fit.fit(optimizer<span class="op">=</span>pyro.optim.ClippedAdam({}), num_steps<span class="op">=</span><span class="dv">5000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-104-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ccace0cf" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>velocity_fit.speed_pyro.means</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pancreas_ductal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">nu0</td>
<td>0.366409</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="12f0ca6a" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put estimations in new objects</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>cycle_pyro <span class="op">=</span> velocity_fit.cycle_pyro</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>phase_pyro <span class="op">=</span> velocity_fit.phase_pyro</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>speed_pyro <span class="op">=</span> velocity_fit.speed_pyro</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>fit_ElogS <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS"</span>].squeeze()</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>fit_ElogU <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU"</span>].squeeze()</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>fit_ElogS2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS2"</span>].squeeze()</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>fit_ElogU2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU2"</span>].squeeze()</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>log_gammas <span class="op">=</span> velocity_fit.log_gammas</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>log_betas <span class="op">=</span> velocity_fit.log_betas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="828a1528" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store entire posterior sampling into an object</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>full_pps_velo <span class="op">=</span> velocity_fit.posterior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e8ae0c4e" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See the value of the mean gamma</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>array(1.7233645, dtype=float32)</code></pre>
</div>
</div>
<div id="45050674-d91a-41c8-b08c-cf9c859cd5eb" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the constant velocity estimate</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>omega <span class="op">=</span> full_pps_velo[<span class="st">"ω"</span>].squeeze().numpy() <span class="op">/</span> torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> phase_pyro.phis</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>omegas <span class="op">=</span> []</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>phis <span class="op">=</span> []</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>n2n <span class="op">=</span> {<span class="st">"Ductal"</span>:<span class="dv">0</span>}</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> np.array([n2n[i] <span class="cf">for</span> i <span class="kw">in</span> np.array(data_to_fit.obs[<span class="st">"clusters"</span>])])</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data_to_fit.obs[<span class="st">"clusters"</span>].unique())):</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    omega1 <span class="op">=</span> omega[:,np.where(ids <span class="op">==</span> i)]</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    phi1 <span class="op">=</span> phi[np.where(ids <span class="op">==</span> i)]</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    omegas.append(omega1)</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    phis.append(phi1)</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.array(data_to_fit.obs[<span class="st">"clusters"</span>].unique()) <span class="co">#list(adatas.keys())</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"tab:blue"</span>, <span class="st">"tab:orange"</span>, <span class="st">"tab:green"</span>, <span class="st">"tab:red"</span>]</span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(omegas)):</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>    plt.plot(phis[i][np.argsort(phis[i])], omegas[i].mean(<span class="dv">0</span>)[<span class="dv">0</span>][np.argsort(phis[i])], c<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>)</span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    tmp5 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>    tmp95 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">95</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).mean(), ((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).std())</span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>    phi_i <span class="op">=</span> phi[ids<span class="op">==</span>i] </span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(x<span class="op">=</span>phi_i[np.argsort(phi_i)],</span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a>                     y1<span class="op">=</span>tmp5[np.argsort(phi_i)], </span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>                     y2<span class="op">=</span>tmp95[np.argsort(phi_i)], </span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span>colors[i], label <span class="op">=</span> labels[i])</span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"phase"</span>)</span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"omega"</span>)</span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.ylim(0.2, 0.5)</span></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-94.75724 3372.2334</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-109-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6a1b113b" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the constant velocity estimate</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>omega <span class="op">=</span> full_pps_velo[<span class="st">"ω"</span>].squeeze().numpy() <span class="op">/</span> torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> phase_pyro.phis</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>omegas <span class="op">=</span> []</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>phis <span class="op">=</span> []</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>n2n <span class="op">=</span> {<span class="st">"pancreas_ductal"</span>:<span class="dv">0</span>}</span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> np.array([n2n[i] <span class="cf">for</span> i <span class="kw">in</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>])])</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data_to_fit.obs[<span class="st">"batch"</span>].unique())):</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    omega1 <span class="op">=</span> omega[:,np.where(ids <span class="op">==</span> i)]</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>    phi1 <span class="op">=</span> phi[np.where(ids <span class="op">==</span> i)]</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    omegas.append(omega1)</span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    phis.append(phi1)</span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>].unique()) <span class="co">#list(adatas.keys())</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"tab:blue"</span>, <span class="st">"tab:orange"</span>, <span class="st">"tab:green"</span>, <span class="st">"tab:red"</span>]</span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(omegas)):</span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>    plt.plot(phis[i][np.argsort(phis[i])], omegas[i].mean(<span class="dv">0</span>)[<span class="dv">0</span>][np.argsort(phis[i])], c<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>)</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>    tmp5 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>    tmp95 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">95</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).mean(), ((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).std())</span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>    phi_i <span class="op">=</span> phi[ids<span class="op">==</span>i] </span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(x<span class="op">=</span>phi_i[np.argsort(phi_i)],</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>                     y1<span class="op">=</span>tmp5[np.argsort(phi_i)], </span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>                     y2<span class="op">=</span>tmp95[np.argsort(phi_i)], </span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span>colors[i], label <span class="op">=</span> labels[i])</span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"phase"</span>)</span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"omega"</span>)</span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.ylim(0.2, 0.5)</span></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15.6074705 0.82132316</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-112-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9b18e20e-ed8d-45cd-8e8b-829fe3589a9b" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>plt.hist(omegas[<span class="dv">0</span>][:, <span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Velocity Estimate"</span>)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Periodic Model Velocity Posterior"</span>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-113-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5a00982d-27d3-43fa-a553-a26c42e0ffa4" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> velocity_fit.metaparams</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> velocity_fit.metaparams_avg</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co">#pickle.dump(velocity_fit, open("pickle_result_outputs/IrinaFibro_Med_velo_5Ktraining_fit_03042024.pkl", "wb"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="48e2f83e-28dc-49e6-bc0a-a0a8acc55d90" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>velocity_fit0 <span class="op">=</span> velocity_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c019d625-c615-408f-a444-7013f2b27bd4" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>pyro.clear_param_store()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3fe261ad-abdf-48c4-a8a6-98d9e1eecd71" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>condition_design_matrix <span class="op">=</span> copy.deepcopy(batch_design_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bfec6581-c52d-4c36-9174-cacb7056c0aa" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>n_velo_harmonics <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>speed_prior <span class="op">=</span> angularspeed.AngularSpeed.trivial_prior(condition_names<span class="op">=</span>[<span class="st">"pancreas_ductal"</span>], harmonics<span class="op">=</span>n_velo_harmonics, </span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>                                                means<span class="op">=</span><span class="fl">0.0</span>, stds<span class="op">=</span><span class="fl">3.0</span>)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>speed_prior.stds.loc[<span class="st">"nu1_cos"</span>] <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>speed_prior.stds.loc[<span class="st">"nu1_sin"</span>] <span class="op">=</span> <span class="fl">0.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="640f9f02-1401-4379-a8e2-d7511c44097e" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>condition_on_dict <span class="op">=</span> {<span class="st">"ϕxy"</span>:phase_pyro.phi_xy_tensor.T.to(device),</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"ν"</span>: cycle_pyro.means_tensor.T.unsqueeze(<span class="op">-</span><span class="dv">2</span>).to(device),</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Δν"</span>: torch.tensor(phase_fit.delta_nus).to(device),</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"shape_inv"</span>: torch.tensor(phase_fit.disp_pyro).unsqueeze(<span class="op">-</span><span class="dv">1</span>).to(device)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c185bff5-c8b6-443a-a1eb-d9aa931dc562" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>metaparameters_velocity <span class="op">=</span> preprocessing.preprocess_for_velocity_estimation(data_to_fit, </span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>                                                             cycle_pyro, </span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>                                                             phase_pyro, </span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>                                                             speed_prior,</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>                                                             condition_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>                                                             batch_design_matrix.<span class="bu">float</span>(), </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>                                                             n_harmonics<span class="op">=</span>n_harm,</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>                                                             count_factor<span class="op">=</span>metapar.count_factor,</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>                                                             ω_n_harmonics<span class="op">=</span>n_velo_harmonics, </span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>                                                             gene_selection_model<span class="op">=</span><span class="st">"all"</span>,</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>                                                             normalize<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>                                                             noisemodel<span class="op">=</span><span class="st">"NegativeBinomial"</span>,</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>                                                             μγ<span class="op">=</span>torch.tensor(<span class="fl">0.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>                                                             σγ<span class="op">=</span>torch.tensor(<span class="fl">0.5</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>                                                             μβ<span class="op">=</span>torch.tensor(<span class="fl">2.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>                                                             σβ<span class="op">=</span>torch.tensor(<span class="fl">3.0</span>).detach().clone().<span class="bu">float</span>(),</span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>                                                             device<span class="op">=</span>device, </span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>                                                             model_type<span class="op">=</span><span class="st">"lrmn"</span>,</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>                                                             rho_mean<span class="op">=</span>torch.tensor(<span class="fl">4.0</span>).to(device),</span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>                                                             rho_rank<span class="op">=</span>torch.tensor(<span class="dv">5</span>).to(device),</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>                                                             condition_on<span class="op">=</span>condition_on_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="603a23fd-aeb9-44b7-89b6-4de56b7a5c0e" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>velocity_fit <span class="op">=</span> velocity_inference_model.VelocityFitModel(metaparams<span class="op">=</span>metaparameters_velocity, </span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>                                                         condition_on<span class="op">=</span>condition_on_dict, early_exit<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>                                                        num_samples<span class="op">=</span><span class="dv">500</span>, n_per_bin<span class="op">=</span><span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cab3607d-4336-41a8-b4c8-5ec94d19d217" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>velocity_fit.check_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Trace Shapes:                                
   Param Sites:                                
  Sample Sites:                                
     cells dist               |                
          value           916 |                
     genes dist               |                
          value           254 |                
 harmonics dist               |                
          value             3 |                
conditions dist               |                
          value             1 |                
   batches dist               |                
          value             1 |                
     logγg dist       254   1 |                
          value       254   1 |                
     logβg dist       254   1 |                
          value       254   1 |                
  rho_real dist       254   1 |                
          value       254   1 |                
        γg dist       254   1 | 254   1        
          value               | 254   1        
         ν dist       254   1 |   3            
          value       254   1 |   3            
        Δν dist 1 1 1 254   1 |                
          value 1 1 1 254   1 |                
       ϕxy dist           916 |   2            
          value           916 |   2            
         ϕ dist               | 916            
          value               | 916            
         ζ dist               | 916   3        
          value               | 916   3        
      ζ_dϕ dist               | 916   3        
          value               | 916   3        
        νω dist   1 3   1   1 |                
          value   1 3   1   1 |                
        ζω dist               |   3 916        
          value               |   3 916        
     ElogS dist               |   1   1 254 916
          value               |   1   1 254 916
         ω dist               |   1 916        
          value               |   1 916        
     ElogU dist               |   1   1 254 916
          value               |   1   1 254 916
 shape_inv dist       254   1 |                
          value       254   1 |                
         S dist   1 1 254 916 |                
          value       254 916 |                
         U dist   1 1 254 916 |                
          value       254 916 |                </code></pre>
</div>
</div>
<div id="c1814f07-44d5-412c-a9b1-ace1050311f4" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>velocity_fit.check_guide()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Trace Shapes:                
   Param Sites:                
         ν_locs     254   1   3
       ν_scales     254   1   3
        Δν_locs 1 1   1 254   1
       ϕxy_locs         916   2
     logβg_locs         254   1
   logβg_scales         254   1
            loc             257
     cov_factor         257   5
       cov_diag             257
   rho_real_loc             254
 shape_inv_locs         254   1
  Sample Sites:                
     cells dist               |
          value         916   |
     genes dist               |
          value         254   |
 harmonics dist               |
          value           3   |
conditions dist               |
          value           1   |
   batches dist               |
          value           1   |
     logγg dist     254   1   |
          value     254   1   |
  rho_real dist     254   1   |
          value     254   1   |
     logβg dist     254   1   |
          value     254   1   |
        νω dist 1 3   1   1   |
          value 1 3   1   1   |</code></pre>
</div>
</div>
<div id="518587ce-b50c-4625-be05-b1e85545ebfb" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>num_steps <span class="op">=</span> <span class="dv">8000</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>initial_lr <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>final_lr <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> final_lr <span class="op">/</span> initial_lr</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>lrd <span class="op">=</span> gamma <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> num_steps)</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>adam <span class="op">=</span> pyro.optim.ClippedAdam({<span class="st">'lr'</span>: initial_lr, <span class="st">'lrd'</span>: lrd, <span class="st">'betas'</span>: (<span class="fl">0.80</span>, <span class="fl">0.99</span>)})</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>velocity_fit.fit(optimizer<span class="op">=</span>adam, num_steps<span class="op">=</span>num_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-124-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e5628a73-7631-4870-bb34-68040f1e8087" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Put estimations in new objects</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>cycle_pyro <span class="op">=</span> velocity_fit.cycle_pyro</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>phase_pyro <span class="op">=</span> velocity_fit.phase_pyro</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>speed_pyro <span class="op">=</span> velocity_fit.speed_pyro</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>fit_ElogS <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS"</span>].squeeze()</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>fit_ElogU <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU"</span>].squeeze()</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>fit_ElogS2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogS2"</span>].squeeze()</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>fit_ElogU2 <span class="op">=</span> velocity_fit.posterior[<span class="st">"ElogU2"</span>].squeeze()</span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>log_gammas <span class="op">=</span> velocity_fit.log_gammas</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>log_betas <span class="op">=</span> velocity_fit.log_betas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3538f734-1bdf-4d03-9600-83d30aa10bc4" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Store entire posterior sampling into an object</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>full_pps_velo <span class="op">=</span> velocity_fit.posterior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d1250e49-24d7-4a41-ad1a-f00f4e9efacb" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See the value of the mean gamma</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>array(1.0071797, dtype=float32)</code></pre>
</div>
</div>
<div id="8240280c-a856-4bb0-8a3a-40a2978b80f7" class="cell" data-scrolled="true" data-execution_count="154">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>omega <span class="op">=</span> full_pps_velo[<span class="st">"ω"</span>].squeeze().numpy() <span class="op">/</span> torch.exp(torch.mean(full_pps_velo[<span class="st">"logγg"</span>].squeeze().mean(<span class="dv">0</span>).detach())).numpy()</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> phase_pyro.phis</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>omegas <span class="op">=</span> []</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>phis <span class="op">=</span> []</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>n2n <span class="op">=</span> {<span class="st">"pancreas_ductal"</span>:<span class="dv">0</span>}</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> np.array([n2n[i] <span class="cf">for</span> i <span class="kw">in</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>])])</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(data_to_fit.obs[<span class="st">"batch"</span>].unique())):</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    omega1 <span class="op">=</span> omega[:,np.where(ids <span class="op">==</span> i)]</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    phi1 <span class="op">=</span> phi[np.where(ids <span class="op">==</span> i)]</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    omegas.append(omega1)</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    phis.append(phi1)</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.array(data_to_fit.obs[<span class="st">"batch"</span>].unique()) <span class="co">#list(adatas.keys())</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"tab:blue"</span>, <span class="st">"tab:orange"</span>, <span class="st">"tab:green"</span>, <span class="st">"tab:red"</span>]</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(omegas)):</span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>    plt.plot(phis[i][np.argsort(phis[i])], omegas[i].mean(<span class="dv">0</span>)[<span class="dv">0</span>][np.argsort(phis[i])], c<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">'dashed'</span>)</span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>    tmp5 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>    tmp95 <span class="op">=</span> np.percentile(omega[:, ids<span class="op">==</span>i], <span class="dv">95</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).mean(), ((<span class="dv">2</span><span class="op">*</span>np.pi)<span class="op">/</span>omega[:, ids<span class="op">==</span>i]).std())</span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>    phi_i <span class="op">=</span> phi[ids<span class="op">==</span>i] </span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(x<span class="op">=</span>phi_i[np.argsort(phi_i)],</span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>                     y1<span class="op">=</span>tmp5[np.argsort(phi_i)], </span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>                     y2<span class="op">=</span>tmp95[np.argsort(phi_i)], </span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>                     alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span>colors[i], label <span class="op">=</span> labels[i])</span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"phase"</span>)</span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"omega"</span>)</span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.ylim(0.2, 0.5)</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>18.374376 3.3306985</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RNA_Velocity_D3B2-3_files/figure-html/cell-128-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/sib-swiss\.github\.io\/single-cell-python-training\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>